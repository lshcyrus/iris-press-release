<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Coverage Web App</title>
    <style>
        /* WordPress/Elementor compatibility styles */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: auto !important;
            min-height: 100% !important;
            overflow-x: visible !important;
            overflow-y: hidden !important;
        }
        
        /* Override any WordPress/Elementor height restrictions */
        #tables-container {
            height: auto !important;
            min-height: 100% !important;
            overflow: visible !important;
            overflow-x: auto;
            width: 100% !important;
            box-sizing: border-box !important;
            font-family: 'Raleway', sans-serif !important;
        }
        
        /* Force container to expand with content */
        .responsive-table {
            height: auto !important;
            overflow: visible !important;
        }
        
        /* Ensure tables are fully visible */
        table {
            height: auto !important;
            overflow: visible !important;
        }

        /* Base font sizes for desktop */
        .responsive-table { font-size: 16px; margin-bottom: 20px; }
        .responsive-table td { padding: 8px; vertical-align: top; }

        /* Tablet sizes (768px - 1024px) */
        @media screen and (max-width: 1024px) {
          .responsive-table { font-size: 15px; }
          .responsive-table td { padding: 7px; }
        }

        /* Small tablet/large mobile (480px - 768px) */
        @media screen and (max-width: 768px) {
          .responsive-table { font-size: 14px; }
          .responsive-table table { border: 0; }
          .responsive-table thead { border: none; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; width: 1px; }
          .responsive-table tr { border-radius: 8px; display: block; margin-bottom: 15px; padding: 12px; background: #f9f9f9; }
          .responsive-table td { border: none; display: block; padding: 6px 0; text-align: left; }
          .responsive-table td:before { content: attr(data-label) ": "; font-weight: bold; display: inline-block; width: 70px; margin-right: 8px; color: #333; vertical-align: top; font-size: 13px; }
          .responsive-table td[data-label="Date"] { white-space: nowrap; font-size: 13px; }
          .responsive-table td[data-label="Media"] { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-size: 13px; }
          .responsive-table td[data-label="Title"] { word-wrap: break-word; line-height: 1.3; font-size: 14px; }
          .responsive-table .year-header { background-color: #007cba !important; color: white !important; text-align: center; font-size: 16px; padding: 12px !important; margin-bottom: 15px; border-radius: 8px; }
          .responsive-table .year-header:before { content: none !important; }
        }

        /* Mobile phones (max 480px) */
        @media screen and (max-width: 480px) {
          .responsive-table { font-size: 13px; }
          .responsive-table tr { padding: 10px; margin-bottom: 12px; }
          .responsive-table td:before { width: 60px; margin-right: 6px; font-size: 12px; }
          .responsive-table td[data-label="Date"] { font-size: 12px; }
          .responsive-table td[data-label="Media"] { font-size: 12px; }
          .responsive-table td[data-label="Title"] { font-size: 13px; line-height: 1.2; }
          .responsive-table .year-header { font-size: 14px; padding: 10px !important; margin-bottom: 12px; }
        }

        /* Very small phones (max 360px) */
        @media screen and (max-width: 360px) {
          .responsive-table { font-size: 12px; }
          .responsive-table tr { padding: 8px; margin-bottom: 10px; }
          .responsive-table td:before { width: 55px; margin-right: 5px; font-size: 11px; }
          .responsive-table td[data-label="Date"] { font-size: 11px; }
          .responsive-table td[data-label="Media"] { font-size: 11px; }
          .responsive-table td[data-label="Title"] { font-size: 12px; line-height: 1.2; }
          .responsive-table .year-header { font-size: 13px; padding: 8px !important; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div id="tables-container"></div>

    <script>
        async function fetchAndRenderData() {
            const sheetId = '1Tz0Sn3QZ-rEd192Xj1DZ95jcIaGNvVC4';
            const sheetName = 'Sheet1';
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

            // Get URL parameter for specific year (e.g., ?year=2025)
            const params = new URLSearchParams(window.location.search);
            const requestedYear = params.get('year') ? parseInt(params.get('year')) : null;

            try {
                const response = await fetch(url);
                const text = await response.text();
                // Remove prefix up to the first '(', and suffix after the last ')'
                const start = text.indexOf('(');
                const end = text.lastIndexOf(')');
                const jsonString = text.substring(start + 1, end);
                const json = JSON.parse(jsonString);

                const rows = json.table.rows;

                // Map all rows, but skip likely header rows
                let data = rows.map(row => ({
                    date: row.c[0]?.v || '',
                    media: row.c[1]?.v || '',
                    title: row.c[2]?.v || '',
                    link: row.c[3]?.v || ''
                }));

                // Filter out header-like rows (e.g., if date is 'Date')
                data = data.filter(item => item.date && item.date !== 'Date' && item.media && item.title && item.link);

                // Parse and format dates
                data = data.map(item => {
                    let parsedDate = null;
                    let dateFormatted = item.date; // Fallback to raw
                    if (typeof item.date === 'string') {
                        if (item.date.startsWith('Date(')) {
                            const matches = item.date.match(/Date\((\d+),(\d+),(\d+)\)/);
                            if (matches) {
                                const year = parseInt(matches[1]);
                                const month = parseInt(matches[2]) + 1;
                                const day = parseInt(matches[3]);
                                parsedDate = new Date(year, month - 1, day);
                                dateFormatted = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            }
                        } else {
                            parsedDate = new Date(item.date);
                            if (!isNaN(parsedDate)) {
                                dateFormatted = parsedDate.toISOString().split('T')[0]; // YYYY-MM-DD
                            }
                        }
                    }
                    return { ...item, parsedDate, dateFormatted };
                });

                // Filter only rows with valid parsed dates
                data = data.filter(item => item.parsedDate && !isNaN(item.parsedDate));

                // Sort by parsedDate descending
                data.sort((a, b) => b.parsedDate - a.parsedDate);

                // Group by year
                const groups = {};
                data.forEach(item => {
                    const year = item.parsedDate.getFullYear();
                    if (!groups[year]) groups[year] = [];
                    groups[year].push(item);
                });

                const container = document.getElementById('tables-container');

                // If a specific year is requested, show only that year's table
                let yearsToShow = requestedYear ? [requestedYear] : Object.keys(groups).sort((a, b) => b - a);

                yearsToShow.forEach(year => {
                    if (groups[year]) {
                        let tableHTML = `
                            <div class="responsive-table">
                                <table border="0" cellspacing="0" cellpadding="5" style="border-collapse:collapse;width:100%;">
                                    <tbody>
                        `;
                        groups[year].forEach(item => {
                            tableHTML += `
                                <tr>
                                    <td data-label="Date" style="width: 120px; min-width: 120px;">${item.dateFormatted}</td>
                                    <td data-label="Media" style="width: 150px;">${item.media}</td>
                                    <td data-label="Title"><a href="${item.link}" target="_blank">${item.title}</a></td>
                                </tr>
                            `;
                        });
                        tableHTML += `</tbody></table></div>`;
                        container.innerHTML += tableHTML;
                    }
                });

                // If no data for requested year, show message
                if (requestedYear && !groups[requestedYear]) {
                    container.innerHTML = '<p>No data available for the requested year.</p>';
                }

                // Force height recalculation after content is loaded (for WordPress/Elementor)
                const targetOrigin = 'https://group-iris.com';

                function attemptToSendHeight() {
                    // Add a small buffer to the height for safety
                    const newHeight = document.body.scrollHeight + 15;
                    if (newHeight > 15) { // Only send if height is calculated
                        console.log('Attempting to post height:', newHeight, 'to', targetOrigin);
                        parent.postMessage({iframeHeight: newHeight}, targetOrigin);
                    }
                }

                // Send height at different intervals to handle parent page load timing
                setTimeout(attemptToSendHeight, 200);
                setTimeout(attemptToSendHeight, 500);
                setTimeout(attemptToSendHeight, 1000);
                setTimeout(attemptToSendHeight, 2000);

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('tables-container').innerHTML = '<p>Error loading data. Please check the Sheet ID and ensure the sheet is publicly accessible.</p>';
            }
        }

        fetchAndRenderData();
    </script>
</body>
</html>